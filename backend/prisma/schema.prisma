generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== ACCESS CONTROL ====================

model AccessGroup {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  permissions Permission?
  users       User[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("access_groups")
}

model Stage {
  id    String @id @default(uuid())
  name  String
  color String
  order Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stages")
}

model Permission {
  id            String      @id @default(uuid())
  accessGroupId String      @unique
  accessGroup   AccessGroup @relation(fields: [accessGroupId], references: [id], onDelete: Cascade)
  
  // Lead Permissions
  canSearchLeads      Boolean @default(false)  // Pode pesquisar novos leads na API
  canViewAllLeads     Boolean @default(false)  // Pode ver todos os leads (admin)
  canViewOwnLeads     Boolean @default(true)   // Pode ver leads atribuídos a si
  canManageLeads      Boolean @default(false)  // Pode criar/editar/excluir leads
  canAssignLeads      Boolean @default(false)  // Pode atribuir leads a vendedores
  canImportLeads      Boolean @default(false)  // Pode importar leads via CSV/Excel
  canExportLeads      Boolean @default(false)  // Pode exportar leads
  
  // CRM Permissions
  canViewCRM          Boolean @default(true)   // Acesso ao CRM
  canMoveCards        Boolean @default(true)   // Pode mover cards entre colunas
  canManageStages     Boolean @default(false)  // Pode gerenciar funis e etapas
  
  // Module Permissions
  canViewDashboard    Boolean @default(true)   // Acesso ao Dashboard
  canViewCosts        Boolean @default(false)  // Pode ver custos de API
  
  // Chat Permissions
  canViewChat         Boolean @default(false)  // Acesso ao chat WhatsApp
  canSendMessage      Boolean @default(false)  // Pode enviar mensagens
  canDeleteMessages   Boolean @default(false)  // Pode apagar mensagens
  canViewAllChats     Boolean @default(false)  // Pode ver chats de outros usuários
  canManageConnections Boolean @default(false) // Pode conectar/desconectar WhatsApp
  
  // Admin Permissions
  canManageUsers      Boolean @default(false)  // Pode gerenciar usuários
  canManageGroups     Boolean @default(false)  // Pode gerenciar grupos de acesso
  canManageFolders    Boolean @default(false)  // Pode gerenciar pastas
  canViewSystemLogs   Boolean @default(false)  // Pode ver logs do sistema
  canManageSettings   Boolean @default(false)  // Pode gerenciar configurações gerais
  canManageIntegrations Boolean @default(false) // Pode gerenciar integrações
  
  // Personal & Monitoring
  canViewPersonal     Boolean @default(true)
  canManageTasks      Boolean @default(true)   // Pode criar/editar tarefas
  canManageGoals      Boolean @default(true)   // Pode criar/editar metas
  canViewMonitoring   Boolean @default(false)
  canUseOwnWhatsApp   Boolean @default(false) // Permite conectar Whats proprio

  @@map("permissions")
}

model LeadAssignmentHistory {
  id              String   @id @default(uuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  previousUserId  String?
  newUserId       String?
  assignedById    String
  assignedBy      User     @relation("AssignmentsMade", fields: [assignedById], references: [id])
  createdAt       DateTime @default(now())

  @@map("lead_assignment_history")
}

// ==================== USERS ====================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  folders      Folder[]
  interfacePreference String @default("BOTH") // "PC", "MOBILE", "BOTH"
  avatar        String? // URL or identifier for user avatar
  
  // Access Control
  role          String       @default("SELLER") // "SUPER_ADMIN", "ADMIN", "SELLER"
  accessGroupId String?
  accessGroup   AccessGroup? @relation(fields: [accessGroupId], references: [id])
  
  // Custom Tags
  customTag      String?      // Custom badge text (e.g., "Master", "Sales Lead")
  customTagColor String?      // Hex color or specific color name
  
  // WhatsApp Config
  useOwnWhatsApp Boolean @default(false) // Se true, tenta usar sessão do usuario. Se false, usa global.

  // Lead Assignment
  assignedLeads       Company[]               @relation("LeadResponsible")
  assignmentsMade     LeadAssignmentHistory[] @relation("AssignmentsMade")
  
  // Chat Ownership
  userChats           UserChat[]
  
  // Personal & Monitoring Relations
  tasks               Task[]
  goals               Goal[]
  activityLogs        ActivityLog[]
  sessions            UserSession[]
  firstContactTemplates FirstContactTemplate[]

  @@map("users")
}

// ==================== FIRST CONTACT TEMPLATES ====================

model FirstContactTemplate {
  id        String   @id @default(uuid())
  title     String
  body      String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("first_contact_templates")
}

// ==================== LEADS ====================

model Company {
  id            String   @id @default(uuid())
  googlePlaceId String?  @unique // To prevent duplicates and track origin
  name          String
  phone         String?
  email         String?
  type          String   // e.g., lavacar, barbearia
  activityBranch String // e.g., servicos, comercio
  size          String   // e.g., medio, grande
  location      String?
  address       String?
  latitude      Float?
  longitude     Float?
  successChance Float?   // 0-100
  tips          String?
  value         Float?   // Estimated value of the lead
  status        String?  // e.g., contacted, new
  contacted     Boolean  @default(false)
  stageId       String?  // CRM stage ID
  tags          String?  // Comma separated tags if needed, or relation
  website       String?
  comments      String?
  photoUrl      String?  // URL da foto do Google Places
  
  folderId      String?
  folder        Folder?  @relation(fields: [folderId], references: [id])
  
  // Lead Assignment
  responsibleId String?
  responsible   User?   @relation("LeadResponsible", fields: [responsibleId], references: [id])
  assignmentHistory LeadAssignmentHistory[]
  
  // Chat Ownership
  userChats     UserChat[]
  
  // Personal Module Relations
  tasks         Task[]
  activityLogs  ActivityLog[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("companies")
}

model Folder {
  id        String    @id @default(uuid())
  name      String
  color     String    @default("#000000")
  userId    String?
  user      User?     @relation(fields: [userId], references: [id])
  companies Company[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("folders")
}

model Message {
  id         String   @id // WhatsApp Message ID
  body       String
  from       String
  to         String
  senderName String?
  timestamp  Int
  fromMe     Boolean
  chatId     String // The conversation ID (e.g., 551499999999@c.us)
  type       String   @default("chat") // chat, ptt (push to talk), image, etc.
  ack        Int      @default(1)      // 1: sent, 2: delivered, 3: read
  mediaData  String?  // Base64 or path
  createdAt  DateTime @default(now())

  @@index([chatId])
  @@map("messages")
}

model UserChat {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatId    String   // WhatsApp JID (e.g., 5514999999999@s.whatsapp.net)
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())

  @@unique([userId, chatId])
  @@index([userId])
  @@index([chatId])
  @@map("user_chats")
}

model CostLog {
  id        String   @id @default(uuid())
  userId    String?
  query     String
  endpoint  String   // e.g., "textsearch", "details"
  cost      Float
  timestamp DateTime @default(now())

  @@map("cost_logs")
}

// ==================== PERSONAL MODULE ====================

model Task {
  id          String   @id @default(uuid())
  title       String
  description String?
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dueDate     DateTime?
  priority    String   @default("medium") // high, medium, low
  type        String   @default("general") // general, call, message, email, meeting
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tasks")
}

model Goal {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  target    Int
  current   Int      @default(0)
  unit      String   // "leads", "calls", "meetings", "sales"
  icon      String   @default("leads")
  weekStart DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("goals")
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // "call", "email", "meeting", "task", "proposal"
  title     String
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  status    String   @default("completed") // completed, scheduled, pending
  createdAt DateTime @default(now())

  @@map("activity_logs")
}

// ==================== MONITORING MODULE ====================

model UserSession {
  id            String    @id @default(uuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status        String    @default("offline") // online, away, offline
  lastActivity  DateTime  @default(now())
  sessionStart  DateTime  @default(now())
  sessionEnd    DateTime?

  @@map("user_sessions")
}
